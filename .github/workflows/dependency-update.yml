name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: solosuccess-ai/package-lock.json
      
      - name: Check for outdated packages
        working-directory: ./solosuccess-ai
        run: |
          npm outdated || true
          echo "Checking for security vulnerabilities..."
          npm audit || true
      
      - name: Update patch and minor versions
        working-directory: ./solosuccess-ai
        run: |
          npm update
          npm audit fix || true
      
      - name: Run tests
        working-directory: ./solosuccess-ai
        run: npm run test:unit -- --run
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'chore: automated dependency updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated dependency updates for patch and minor versions.
            
            ### Changes
            - Updated npm packages to latest compatible versions
            - Applied security fixes where available
            
            ### Testing
            - âœ… Unit tests passed
            
            Please review the changes and merge if everything looks good.
          branch: automated-dependency-updates
          delete-branch: true
          labels: dependencies, automated

  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Enable auto-merge for Dependabot PRs
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
